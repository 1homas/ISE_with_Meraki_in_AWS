---
#
# Run with `ansible-playbook ise.init_check.yaml`
#
# - name: ISE Init Check
#   hosts: localhost
#   gather_facts: no
#   vars_prompt:
#     - name: project_name
#       prompt: Project Name
#       default: ISEinAWS
#       private: no
#   vars:
#   tasks:


  - name: Query for ISE instances in project "'{{ project_name }}'"
    community.aws.ec2_instance_info:    # get all by default
      filters:
        instance-state-name: [ 'running' ]
        "tag:project": "{{ project_name }}"
        "tag:Name": "ISE"
    register: instances

  # - name: Show instances
  #   ansible.builtin.debug: var=instances

  - name: Show Instances
    loop: "{{ instances.instances }}"
    ansible.builtin.debug: 
      msg:
      - "{{ item.instance_id }} | {{ item.private_ip_address }}"


  - name: Wait for ISE Application Server (GUI) Initialization
    ansible.builtin.uri:
      url: https://{{ instances.instances[0].private_ip_address }}/admin/login.jsp
      method: GET
      follow_redirects: safe
      timeout: 10
      validate_certs: no
      return_content: no
    register: result
    until: result.status == 200
    retries: 1000
    delay: 10

  - name: ISE Initialized
    when: result.status == 200
    ansible.builtin.debug: 
      msg : "âœ… ISE Application Server Initialized"


...
